# Dragon vs Tiger æ¸¸æˆç³»ç»Ÿ - Docker éƒ¨ç½²æ–¹æ¡ˆæ€»ç»“

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

ä¸ºäº†è®©é¡¹ç›®èƒ½å¤Ÿ**å¿«é€Ÿã€ç®€å•åœ°åœ¨ Windows æˆ–å…¶ä»–å¹³å°è¿è¡Œ**ï¼Œæˆ‘ä»¬é‡‡ç”¨äº† **Docker Compose ä¸€é”®éƒ¨ç½²æ–¹æ¡ˆ**ã€‚

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. Docker åŒ–é…ç½®æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `Dockerfile` | åº”ç”¨å®¹å™¨æ„å»ºæ–‡ä»¶ï¼ˆå¤šé˜¶æ®µæ„å»ºï¼Œä¼˜åŒ–é•œåƒå¤§å°ï¼‰ |
| `docker-compose.yml` | æœåŠ¡ç¼–æ’æ–‡ä»¶ï¼ˆåŒ…å«æ‰€æœ‰ä¾èµ–æœåŠ¡ï¼‰ |
| `init.sql` | æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ï¼ˆè‡ªåŠ¨åˆ›å»ºè¡¨å’Œæµ‹è¯•æ•°æ®ï¼‰ |
| `docker/broker.conf` | RocketMQ Broker é…ç½®æ–‡ä»¶ |
| `.dockerignore` | Docker æ„å»ºå¿½ç•¥æ–‡ä»¶ï¼ˆä¼˜åŒ–æ„å»ºé€Ÿåº¦ï¼‰ |

### 2. é…ç½®åˆå§‹åŒ–è„šæœ¬

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `init-etcd-config.sh` | Bash è„šæœ¬ï¼ˆmacOS/Linux/Git Bash/WSLï¼‰ |
| `init-etcd-config.ps1` | PowerShell è„šæœ¬ï¼ˆWindowsï¼‰ |

### 3. æ–‡æ¡£

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `QUICK_START.md` | å¿«é€Ÿå¯åŠ¨æŒ‡å—ï¼ˆ3 æ­¥å¯åŠ¨ï¼‰ |
| `WINDOWS_DEPLOYMENT_GUIDE.md` | Windows è¯¦ç»†éƒ¨ç½²æŒ‡å— |
| `DOCKER_DEPLOYMENT_SUMMARY.md` | æœ¬æ–‡æ¡£ï¼ˆæ–¹æ¡ˆæ€»ç»“ï¼‰ |

---

## ğŸ¯ æ–¹æ¡ˆä¼˜åŠ¿

### 1. è·¨å¹³å°
- âœ… Windows 10/11
- âœ… macOS (Intel/Apple Silicon)
- âœ… Linux (Ubuntu/CentOS/Debian)
- **å®Œå…¨ä¸€è‡´çš„è¿è¡Œç¯å¢ƒ**

### 2. é›¶é…ç½®
- âŒ æ— éœ€å®‰è£… MySQL
- âŒ æ— éœ€å®‰è£… Redis
- âŒ æ— éœ€å®‰è£… etcd
- âŒ æ— éœ€å®‰è£… RocketMQ
- âœ… åªéœ€å®‰è£… Docker Desktop

### 3. ä¸€é”®å¯åŠ¨
```bash
# 3 æ¡å‘½ä»¤å¯åŠ¨æ‰€æœ‰æœåŠ¡
./init-etcd-config.sh
docker-compose up -d --build
docker-compose logs -f dt-server
```

### 4. ç¯å¢ƒéš”ç¦»
- æ‰€æœ‰æœåŠ¡è¿è¡Œåœ¨å®¹å™¨ä¸­
- ä¸æ±¡æŸ“æœ¬åœ°ç¯å¢ƒ
- æ•°æ®æŒä¹…åŒ–åœ¨ Docker volumes
- å¯ä»¥éšæ—¶æ¸…ç©ºé‡æ¥

### 5. æ˜“äºè¿ç§»
- æ‰“åŒ…é¡¹ç›®æ–‡ä»¶å¤¹
- åœ¨ä»»ä½•æœºå™¨ä¸Šè¿è¡Œ
- æ— éœ€é‡æ–°é…ç½®

---

## ğŸ—ï¸ æ¶æ„è¯´æ˜

### æœåŠ¡ç»„æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Docker Network                        â”‚
â”‚                     (dt-network)                         â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  MySQL   â”‚  â”‚  Redis   â”‚  â”‚   etcd   â”‚             â”‚
â”‚  â”‚  :3306   â”‚  â”‚  :6379   â”‚  â”‚  :2379   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚         RocketMQ NameServer          â”‚              â”‚
â”‚  â”‚              :9876                    â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                      â†“                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚          RocketMQ Broker             â”‚              â”‚
â”‚  â”‚         :10909/10911/10912           â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                      â†“                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚           dt-server (Go)             â”‚              â”‚
â”‚  â”‚              :8087                    â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                      â†“                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
                 Host Machine
                 localhost:8087
```

### æ•°æ®æŒä¹…åŒ–

```
Docker Volumes:
â”œâ”€â”€ mysql_data          â†’ MySQL æ•°æ®æ–‡ä»¶
â”œâ”€â”€ redis_data          â†’ Redis æŒä¹…åŒ–æ–‡ä»¶
â”œâ”€â”€ etcd_data           â†’ etcd æ•°æ®æ–‡ä»¶
â”œâ”€â”€ rocketmq_namesrv_logs   â†’ RocketMQ NameServer æ—¥å¿—
â”œâ”€â”€ rocketmq_broker_logs    â†’ RocketMQ Broker æ—¥å¿—
â””â”€â”€ rocketmq_broker_store   â†’ RocketMQ æ¶ˆæ¯å­˜å‚¨
```

---

## ğŸ“¦ æœåŠ¡é…ç½®

### 1. MySQL
- **é•œåƒ**ï¼š`mysql:8.0`
- **ç«¯å£**ï¼š3306
- **ç”¨æˆ·**ï¼šroot / root
- **æ•°æ®åº“**ï¼šdt_game
- **åˆå§‹åŒ–**ï¼šè‡ªåŠ¨æ‰§è¡Œ `init.sql`
- **å­—ç¬¦é›†**ï¼šutf8mb4

### 2. Redis
- **é•œåƒ**ï¼š`redis:7-alpine`
- **ç«¯å£**ï¼š6379
- **æŒä¹…åŒ–**ï¼šAOF æ¨¡å¼

### 3. etcd
- **é•œåƒ**ï¼š`bitnami/etcd:latest`
- **ç«¯å£**ï¼š2379, 2380
- **è®¤è¯**ï¼šå…³é—­ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

### 4. RocketMQ
- **é•œåƒ**ï¼š`apache/rocketmq:5.3.0`
- **NameServer ç«¯å£**ï¼š9876
- **Broker ç«¯å£**ï¼š10909, 10911, 10912
- **è‡ªåŠ¨åˆ›å»º Topic**ï¼šå¼€å¯

### 5. dt-server (åº”ç”¨)
- **æ„å»º**ï¼šå¤šé˜¶æ®µæ„å»ºï¼ˆç¼–è¯‘ + è¿è¡Œï¼‰
- **ç«¯å£**ï¼š8087
- **ç¯å¢ƒå˜é‡**ï¼š
  - `ETCD_ENDPOINTS=etcd:2379`
  - `ETCD_CONFIG_KEY=/dt-server/config/dev`
  - `TZ=Asia/Shanghai`

---

## ğŸš€ ä½¿ç”¨æµç¨‹

### é¦–æ¬¡éƒ¨ç½²

```bash
# 1. å®‰è£… Docker Desktop
# ä¸‹è½½ï¼šhttps://www.docker.com/products/docker-desktop/

# 2. å…‹éš†é¡¹ç›®
git clone <your-repo-url>
cd dt-server

# 3. åˆå§‹åŒ–é…ç½®
./init-etcd-config.sh  # macOS/Linux
# æˆ–
.\init-etcd-config.ps1  # Windows

# 4. å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d --build

# 5. æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# 6. æŸ¥çœ‹åº”ç”¨æ—¥å¿—
docker-compose logs -f dt-server

# 7. æµ‹è¯• API
curl -X POST http://localhost:8087/api/game_event \
  -H "Content-Type: application/json" \
  -d '{"game_id":"game_001","room_id":"room_001","game_round_id":"round_test_1","event_type":1}'
```

### æ—¥å¸¸å¼€å‘

```bash
# ä¿®æ”¹ä»£ç åé‡æ–°æ„å»º
docker-compose up -d --build dt-server

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f dt-server

# é‡å¯æœåŠ¡
docker-compose restart dt-server

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose stop

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose start
```

### æ•°æ®ç®¡ç†

```bash
# è¿æ¥ MySQL
docker exec -it dt-mysql mysql -uroot -proot dt_game

# è¿æ¥ Redis
docker exec -it dt-redis redis-cli

# æŸ¥çœ‹ etcd é…ç½®
docker exec dt-etcd etcdctl get /dt-server/config/dev

# æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼ˆæ…ç”¨ï¼‰
docker-compose down -v
```

---

## ğŸ”§ é…ç½®è¯´æ˜

### etcd é…ç½®ç»“æ„

```json
{
  "app": {
    "name": "dt-server",
    "version": "1.0.0",
    "env": "dev"
  },
  "server": {
    "port": 8087,
    "read_timeout": 30,
    "write_timeout": 30
  },
  "database": {
    "dsn": "root:root@tcp(mysql:3306)/dt_game?charset=utf8mb4&parseTime=True&loc=Local",
    "max_idle_conns": 10,
    "max_open_conns": 100
  },
  "redis": {
    "addr": "redis:6379",
    "password": "",
    "db": 0,
    "pool_size": 10
  },
  "rocketmq": {
    "name_server": "rocketmq-namesrv:9876",
    "group": "dt-server-group",
    "retry_times": 3
  },
  "game": {
    "bet_window_seconds": 45,
    "odds": {
      "dragon": 0.97,
      "tiger": 0.97,
      "tie": 8.0
    }
  }
}
```

**æ³¨æ„**ï¼š
- æ•°æ®åº“ DSN ä½¿ç”¨å®¹å™¨å `mysql:3306`ï¼ˆä¸æ˜¯ localhostï¼‰
- Redis åœ°å€ä½¿ç”¨å®¹å™¨å `redis:6379`
- RocketMQ ä½¿ç”¨å®¹å™¨å `rocketmq-namesrv:9876`

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. å¤šé˜¶æ®µæ„å»º
```dockerfile
# ç¼–è¯‘é˜¶æ®µï¼šä½¿ç”¨å®Œæ•´çš„ Go é•œåƒ
FROM golang:1.21-alpine AS builder
# ... ç¼–è¯‘ä»£ç  ...

# è¿è¡Œé˜¶æ®µï¼šä½¿ç”¨æœ€å°çš„ Alpine é•œåƒ
FROM alpine:latest
# ... åªå¤åˆ¶ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ ...
```

**ä¼˜åŠ¿**ï¼š
- ç¼–è¯‘é˜¶æ®µé•œåƒï¼š~800MB
- æœ€ç»ˆè¿è¡Œé•œåƒï¼š~20MB
- å‡å°‘ 97.5% çš„é•œåƒå¤§å°

### 2. å¥åº·æ£€æŸ¥
æ‰€æœ‰æœåŠ¡éƒ½é…ç½®äº†å¥åº·æ£€æŸ¥ï¼Œç¡®ä¿æœåŠ¡å°±ç»ªåæ‰å¯åŠ¨ä¾èµ–æœåŠ¡ã€‚

### 3. èµ„æºé™åˆ¶
å¯ä»¥åœ¨ `docker-compose.yml` ä¸­æ·»åŠ èµ„æºé™åˆ¶ï¼š
```yaml
deploy:
  resources:
    limits:
      cpus: '2'
      memory: 2G
```

---

## â“ å¸¸è§é—®é¢˜

### 1. Windows ä¸Š Docker Desktop å¯åŠ¨å¤±è´¥
**è§£å†³æ–¹æ¡ˆ**ï¼š
```powershell
# ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ
wsl --install
wsl --set-default-version 2
wsl --update
```

### 2. ç«¯å£è¢«å ç”¨
**è§£å†³æ–¹æ¡ˆ**ï¼šä¿®æ”¹ `docker-compose.yml` ä¸­çš„ç«¯å£æ˜ å°„
```yaml
ports:
  - "8088:8087"  # å°†ä¸»æœºç«¯å£æ”¹ä¸º 8088
```

### 3. æœåŠ¡å¯åŠ¨æ…¢
**åŸå› **ï¼šé¦–æ¬¡å¯åŠ¨éœ€è¦ä¸‹è½½é•œåƒï¼ˆçº¦ 2GBï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼šè€å¿ƒç­‰å¾…ï¼Œåç»­å¯åŠ¨ä¼šå¾ˆå¿«

### 4. åº”ç”¨æ— æ³•è¿æ¥æ•°æ®åº“
**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥ MySQL å¥åº·çŠ¶æ€
docker-compose ps mysql

# æŸ¥çœ‹ MySQL æ—¥å¿—
docker-compose logs mysql

# é‡å¯ MySQL
docker-compose restart mysql
```

---

## ğŸ‰ æ€»ç»“

### å®ç°ç›®æ ‡
âœ… **ç®€å•**ï¼š3 æ¡å‘½ä»¤å¯åŠ¨  
âœ… **å¿«é€Ÿ**ï¼šé¦–æ¬¡å¯åŠ¨ < 5 åˆ†é’Ÿï¼Œåç»­ < 30 ç§’  
âœ… **è·¨å¹³å°**ï¼šWindows/macOS/Linux å®Œå…¨ä¸€è‡´  
âœ… **é›¶é…ç½®**ï¼šæ— éœ€æ‰‹åŠ¨å®‰è£…ä»»ä½•ä¾èµ–  
âœ… **æ˜“è¿ç§»**ï¼šæ‰“åŒ…å³å¯åœ¨ä»»ä½•æœºå™¨è¿è¡Œ  

### æ–‡ä»¶æ¸…å•
```
dt-server/
â”œâ”€â”€ Dockerfile                      # åº”ç”¨å®¹å™¨æ„å»ºæ–‡ä»¶
â”œâ”€â”€ docker-compose.yml              # æœåŠ¡ç¼–æ’æ–‡ä»¶
â”œâ”€â”€ init.sql                        # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â”œâ”€â”€ .dockerignore                   # Docker æ„å»ºå¿½ç•¥æ–‡ä»¶
â”œâ”€â”€ init-etcd-config.sh             # Bash é…ç½®åˆå§‹åŒ–è„šæœ¬
â”œâ”€â”€ init-etcd-config.ps1            # PowerShell é…ç½®åˆå§‹åŒ–è„šæœ¬
â”œâ”€â”€ QUICK_START.md                  # å¿«é€Ÿå¯åŠ¨æŒ‡å—
â”œâ”€â”€ WINDOWS_DEPLOYMENT_GUIDE.md     # Windows è¯¦ç»†éƒ¨ç½²æŒ‡å—
â””â”€â”€ DOCKER_DEPLOYMENT_SUMMARY.md    # æœ¬æ–‡æ¡£
```

### ä¸‹ä¸€æ­¥
1. é˜…è¯» [QUICK_START.md](./QUICK_START.md) å¿«é€Ÿå¯åŠ¨
2. é˜…è¯» [WINDOWS_DEPLOYMENT_GUIDE.md](./WINDOWS_DEPLOYMENT_GUIDE.md) äº†è§£è¯¦ç»†é…ç½®
3. å¼€å§‹å¼€å‘å’Œæµ‹è¯•

---

**å®ç°æ—¥æœŸ**ï¼š2025-10-17  
**å®ç°äººå‘˜**ï¼šAugment Agent  
**æ–¹æ¡ˆçŠ¶æ€**ï¼šâœ… å·²å®Œæˆå¹¶æµ‹è¯•

