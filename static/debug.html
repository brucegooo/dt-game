<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API è°ƒè¯• - å¤šå¹³å°è®¤è¯ç‰ˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 30px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .config-section {
            background: #e3f2fd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
        }
        .config-section h3 {
            margin-top: 0;
            color: #1976D2;
        }
        .config-row {
            margin: 10px 0;
            display: flex;
            align-items: center;
        }
        .config-row label {
            width: 150px;
            font-weight: bold;
            color: #555;
        }
        .config-row input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
        }
        .api-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .api-section h2 {
            margin-top: 0;
            color: #555;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
            margin: 10px 0;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        .response {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #f44336; }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }
        .badge-admin { background: #ff9800; color: white; }
        .badge-platform { background: #2196F3; color: white; }
    </style>
</head>
<body>
    <h1>ğŸ® æ¸¸æˆ API è°ƒè¯•å·¥å…·</h1>

    <!-- è®¤è¯é…ç½® -->
    <div class="config-section">
        <h3>ğŸ” è®¤è¯é…ç½®</h3>
        <div class="config-row">
            <label>ç®¡ç†å‘˜Token:</label>
            <input type="text" id="adminToken" value="admin_secret_token_change_in_production">
        </div>
        <div class="config-row">
            <label>å¹³å°AppKey:</label>
            <input type="text" id="platformKey" value="demo_platform">
        </div>
        <div class="config-row">
            <label>å¹³å°ç”¨æˆ·ID:</label>
            <input type="text" id="platformUserId" value="9999">
        </div>
        <div class="config-row">
            <label>å¹³å°ç”¨æˆ·å:</label>
            <input type="text" id="platformUserName" value="Chris">
        </div>
        <p style="margin: 15px 0 0 0; color: #666; font-size: 13px;">
            ğŸ’¡ <strong>æ¼”ç¤ºæ¨¡å¼å·²å¯ç”¨</strong>ï¼šå½“å‰ä½¿ç”¨ç®€åŒ–è®¤è¯ï¼Œåªéœ€æä¾›åŸºæœ¬çš„å¹³å°ä¿¡æ¯å³å¯ã€‚<br>
            ç”Ÿäº§ç¯å¢ƒéœ€è¦ä½¿ç”¨ HMAC-SHA256 ç­¾åè®¤è¯ã€‚
        </p>
    </div>

    <div style="background: #fff3cd; padding: 15px; margin: 20px 0; border-radius: 8px; border-left: 4px solid #ffc107;">
        <strong>âš ï¸ å®Œæ•´æ¸¸æˆæµç¨‹ï¼š</strong>
        <ol style="margin: 10px 0 0 20px; line-height: 1.8;">
            <li><strong>æ¸¸æˆå¼€å§‹</strong>ï¼šè°ƒç”¨æ¸¸æˆäº‹ä»¶ <code>event_type=1</code> (game_start) - åˆ›å»ºæ¸¸æˆå›åˆï¼ŒçŠ¶æ€å˜ä¸º betting</li>
            <li><strong>ç”¨æˆ·æŠ•æ³¨</strong>ï¼šè°ƒç”¨æŠ•æ³¨æ¥å£ - ç”¨æˆ·ä¸‹æ³¨</li>
            <li><strong>æ¸¸æˆå°ç›˜</strong>ï¼šè°ƒç”¨æ¸¸æˆäº‹ä»¶ <code>event_type=2</code> (game_stop) - åœæ­¢ä¸‹æ³¨ï¼ŒçŠ¶æ€å˜ä¸º sealed</li>
            <li><strong>å‘ç‰Œ</strong>ï¼šè°ƒç”¨æ¸¸æˆäº‹ä»¶ <code>event_type=3</code> (new_card) - å‘ç‰Œï¼ŒçŠ¶æ€å˜ä¸º dealt</li>
            <li><strong>å‡†å¤‡å¼€å¥–</strong>ï¼šè°ƒç”¨æ¸¸æˆäº‹ä»¶ <code>event_type=4</code> (game_draw) - å‡†å¤‡å¼€å¥–ï¼ŒçŠ¶æ€å˜ä¸º drawn</li>
            <li><strong>å¼€å¥–ç»“ç®—</strong>ï¼šè°ƒç”¨å¼€å¥–æ¥å£ - è¾“å…¥å¼€å¥–ç»“æœå¹¶ç»“ç®—ï¼ˆ<strong style="color: #d9534f;">å¿…é¡»å®Œæˆæ­¤æ­¥éª¤</strong>ï¼‰</li>
            <li><strong>æ¸¸æˆç»“æŸ</strong>ï¼šè°ƒç”¨æ¸¸æˆäº‹ä»¶ <code>event_type=5</code> (game_end) - ç»“æŸæ¸¸æˆï¼ŒçŠ¶æ€å˜ä¸º finishedï¼ˆ<strong style="color: #d9534f;">å¿…é¡»å…ˆå®Œæˆå¼€å¥–ç»“ç®—</strong>ï¼‰</li>
        </ol>
    </div>

    <!-- æ¸¸æˆäº‹ä»¶ -->
    <div class="api-section">
        <h2>1. æ¸¸æˆäº‹ä»¶ - POST /api/game_event <span class="badge badge-admin">ç®¡ç†å‘˜</span></h2>
        <p style="color: #666; font-size: 13px; margin-bottom: 10px;">
            event_type: 1=æ¸¸æˆå¼€å§‹(initâ†’betting), 2=å°ç›˜(bettingâ†’sealed), 3=å‘ç‰Œ(sealedâ†’dealt), 4=å‡†å¤‡å¼€å¥–(dealtâ†’drawn), 5=ç»“æŸ(drawnâ†’finished)
        </p>
        <textarea id="gameEventInput">{
  "game_id": "dt_game",
  "room_id": "room_001",
  "game_round_id": "round_1234567890",
  "event_type": 1
}</textarea>
        <button onclick="callGameEvent()">å‘é€è¯·æ±‚</button>
        <div id="gameEventResponse" class="response"></div>
    </div>

    <!-- æŠ•æ³¨ -->
    <div class="api-section">
        <h2>2. æŠ•æ³¨ - POST /api/bet <span class="badge badge-platform">å¹³å°è®¤è¯</span></h2>
        <p style="color: #666; font-size: 13px; margin-bottom: 10px;">
            play_type: 1=Dragon, 2=Tiger, 3=Tie | bet_amount: å­—ç¬¦ä¸²æ ¼å¼ï¼ˆæ¼”ç¤ºæ¨¡å¼ä¸‹ä¼šè‡ªåŠ¨åˆ›å»ºç”¨æˆ·ï¼‰<br>
            platform: æŠ•æ³¨å¹³å°ï¼ˆå¯é€‰ï¼Œé»˜è®¤1ï¼‰
        </p>
        <textarea id="betInput">{
  "game_id": "dt_game",
  "room_id": "room_001",
  "game_round_id": "round_1234567890",
  "bet_amount": "100.00",
  "play_type": 1,
  "platform": 1,
  "idempotency_key": "bet_1234567890"
}</textarea>
        <button onclick="callBet()">å‘é€è¯·æ±‚</button>
        <div id="betResponse" class="response"></div>
    </div>

    <!-- å¼€å¥– -->
    <div class="api-section">
        <h2>3. å¼€å¥–ç»“ç®— - POST /api/drawresult <span class="badge badge-admin">ç®¡ç†å‘˜</span></h2>
        <p style="color: #666; font-size: 13px; margin-bottom: 10px;">
            âš ï¸ å¿…é¡»å…ˆè°ƒç”¨ event_type=4 è§¦å‘ game_draw äº‹ä»¶ï¼ŒçŠ¶æ€å˜ä¸º drawn åæ‰èƒ½è°ƒç”¨æ­¤æ¥å£<br>
            card_list: D5,T3,RDragon (Dragonèµ¢) | D1,T2,RTiger (Tigerèµ¢) | D9,T9,RTie (å’Œå±€)
        </p>
        <textarea id="drawInput">{
  "game_id": "dt_game",
  "room_id": "room_001",
  "game_round_id": "round_1234567890",
  "card_list": "D5,T3,RDragon"
}</textarea>
        <button onclick="callDraw()">å‘é€è¯·æ±‚</button>
        <div id="drawResponse" class="response"></div>
    </div>

    <!-- ç”¨æˆ·ä½™é¢æŸ¥è¯¢ -->
    <div class="api-section">
        <h2>4. ç”¨æˆ·ä½™é¢æŸ¥è¯¢ - GET /api/user/balance <span class="badge badge-platform">å¹³å°è®¤è¯</span></h2>
        <p style="color: #666; font-size: 13px; margin-bottom: 10px;">
            æŸ¥è¯¢å¹³å°ç”¨æˆ·çš„å½“å‰ä½™é¢ï¼ˆä½¿ç”¨ä¸Šæ–¹é…ç½®çš„å¹³å°ç”¨æˆ·IDï¼‰
        </p>
        <button onclick="callBalance()">æŸ¥è¯¢ä½™é¢</button>
        <div id="balanceResponse" class="response"></div>
    </div>

    <!-- ç”¨æˆ·æŠ•æ³¨è®°å½•æŸ¥è¯¢ -->
    <div class="api-section">
        <h2>5. ç”¨æˆ·æŠ•æ³¨è®°å½•æŸ¥è¯¢ - GET /api/user/bets <span class="badge badge-platform">å¹³å°è®¤è¯</span></h2>
        <p style="color: #666; font-size: 13px; margin-bottom: 10px;">
            æŸ¥è¯¢å¹³å°ç”¨æˆ·çš„æŠ•æ³¨å†å²è®°å½•ï¼ˆä½¿ç”¨ä¸Šæ–¹é…ç½®çš„å¹³å°ç”¨æˆ·IDï¼‰
        </p>
        <div style="margin: 10px 0;">
            <label>æ¸¸æˆå›åˆID (å¯é€‰): </label>
            <input type="text" id="betsRoundId" value="" placeholder="ç•™ç©ºæŸ¥è¯¢æ‰€æœ‰" style="width: 250px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
            <label style="margin-left: 10px;">é¡µç : </label>
            <input type="text" id="betsPage" value="1" style="width: 60px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
            <label style="margin-left: 10px;">æ¯é¡µæ•°é‡: </label>
            <input type="text" id="betsPageSize" value="10" style="width: 60px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
            <button onclick="callBets()">æŸ¥è¯¢è®°å½•</button>
        </div>
        <div id="betsResponse" class="response"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8087';

        // è·å–ç®¡ç†å‘˜è®¤è¯å¤´
        function getAdminHeaders() {
            const token = document.getElementById('adminToken').value;
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        // è·å–å¹³å°è®¤è¯å¤´ï¼ˆæ¼”ç¤ºæ¨¡å¼ï¼‰
        function getPlatformHeaders() {
            const platformKey = document.getElementById('platformKey').value;
            const platformUserId = document.getElementById('platformUserId').value;
            const platformUserName = document.getElementById('platformUserName').value;
            const timestamp = Math.floor(Date.now() / 1000).toString(); // ç§’çº§æ—¶é—´æˆ³
            const nonce = 'nonce_' + Math.random().toString(36).substring(2, 15);

            return {
                'Content-Type': 'application/json',
                'X-Platform-Key': platformKey,
                'X-Platform-User-Id': platformUserId,
                'X-Platform-User-Name': encodeURIComponent(platformUserName),
                'X-Timestamp': timestamp,
                'X-Nonce': nonce,
                'X-Signature': 'demo_signature_not_required_in_demo_mode'
            };
        }

        // é€šç”¨APIè°ƒç”¨ï¼ˆPOSTï¼‰
        async function callAPI(endpoint, inputId, responseId, headers) {
            const input = document.getElementById(inputId).value;
            const responseEl = document.getElementById(responseId);

            try {
                const data = JSON.parse(input);
                responseEl.textContent = 'è¯·æ±‚ä¸­...';
                responseEl.className = 'response';

                const response = await fetch(API_BASE + endpoint, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(data)
                });

                let result;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    result = await response.text();
                }

                responseEl.className = response.ok ? 'response success' : 'response error';
                responseEl.textContent = `çŠ¶æ€: ${response.status}\n\n` +
                    (typeof result === 'string' ? result : JSON.stringify(result, null, 2));
            } catch (error) {
                responseEl.className = 'response error';
                responseEl.textContent = 'é”™è¯¯: ' + error.message;
            }
        }

        // æ¸¸æˆäº‹ä»¶ï¼ˆç®¡ç†å‘˜è®¤è¯ï¼‰
        function callGameEvent() {
            callAPI('/api/game_event', 'gameEventInput', 'gameEventResponse', getAdminHeaders());
        }

        // æŠ•æ³¨ï¼ˆå¹³å°è®¤è¯ï¼‰
        function callBet() {
            callAPI('/api/bet', 'betInput', 'betResponse', getPlatformHeaders());
        }

        // å¼€å¥–ï¼ˆç®¡ç†å‘˜è®¤è¯ï¼‰
        function callDraw() {
            callAPI('/api/drawresult', 'drawInput', 'drawResponse', getAdminHeaders());
        }

        // ç”¨æˆ·ä½™é¢æŸ¥è¯¢ï¼ˆå¹³å°è®¤è¯ï¼‰
        async function callBalance() {
            const platformUserId = document.getElementById('platformUserId').value;
            const responseEl = document.getElementById('balanceResponse');

            if (!platformUserId) {
                responseEl.className = 'response error';
                responseEl.textContent = 'é”™è¯¯: è¯·åœ¨ä¸Šæ–¹é…ç½®å¹³å°ç”¨æˆ·ID';
                return;
            }

            try {
                responseEl.textContent = 'è¯·æ±‚ä¸­...';
                responseEl.className = 'response';

                const response = await fetch(`${API_BASE}/api/user/balance`, {
                    method: 'GET',
                    headers: getPlatformHeaders()
                });

                let result;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    result = await response.text();
                }

                responseEl.className = response.ok ? 'response success' : 'response error';
                responseEl.textContent = `çŠ¶æ€: ${response.status}\n\n` +
                    (typeof result === 'string' ? result : JSON.stringify(result, null, 2));
            } catch (error) {
                responseEl.className = 'response error';
                responseEl.textContent = 'é”™è¯¯: ' + error.message;
            }
        }

        // ç”¨æˆ·æŠ•æ³¨è®°å½•æŸ¥è¯¢ï¼ˆå¹³å°è®¤è¯ï¼‰
        async function callBets() {
            const platformUserId = document.getElementById('platformUserId').value;
            const roundId = document.getElementById('betsRoundId').value;
            const page = document.getElementById('betsPage').value;
            const pageSize = document.getElementById('betsPageSize').value;
            const responseEl = document.getElementById('betsResponse');

            if (!platformUserId) {
                responseEl.className = 'response error';
                responseEl.textContent = 'é”™è¯¯: è¯·åœ¨ä¸Šæ–¹é…ç½®å¹³å°ç”¨æˆ·ID';
                return;
            }

            try {
                responseEl.textContent = 'è¯·æ±‚ä¸­...';
                responseEl.className = 'response';

                let url = `${API_BASE}/api/user/bets?page=${page}&page_size=${pageSize}`;
                if (roundId) {
                    url += `&game_round_id=${roundId}`;
                }

                const response = await fetch(url, {
                    method: 'GET',
                    headers: getPlatformHeaders()
                });

                let result;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    result = await response.text();
                }

                responseEl.className = response.ok ? 'response success' : 'response error';
                responseEl.textContent = `çŠ¶æ€: ${response.status}\n\n` +
                    (typeof result === 'string' ? result : JSON.stringify(result, null, 2));
            } catch (error) {
                responseEl.className = 'response error';
                responseEl.textContent = 'é”™è¯¯: ' + error.message;
            }
        }

        // é¡µé¢åŠ è½½æ—¶ç”Ÿæˆæ—¶é—´æˆ³å’Œå”¯ä¸€ID
        window.onload = function() {
            const timestamp = Date.now();
            const roundId = 'round_' + timestamp;
            const betKey = 'bet_' + timestamp;

            // æ›´æ–°æ‰€æœ‰è¾“å…¥æ¡†ä¸­çš„ round_id å’Œ idempotency_key
            ['gameEventInput', 'betInput', 'drawInput'].forEach(id => {
                const el = document.getElementById(id);
                let json = JSON.parse(el.value);
                json.game_round_id = roundId;
                if (id === 'betInput') {
                    json.idempotency_key = betKey;
                }
                el.value = JSON.stringify(json, null, 2);
            });

            // æ›´æ–°æŠ•æ³¨è®°å½•æŸ¥è¯¢çš„å›åˆIDæç¤º
            document.getElementById('betsRoundId').placeholder = `ä¾‹å¦‚: ${roundId}`;

            console.log('ğŸ® APIè°ƒè¯•å·¥å…·å·²åŠ è½½');
            console.log('ğŸ“‹ å½“å‰æ¸¸æˆå›åˆID:', roundId);
            console.log('ğŸ” è®¤è¯æ¨¡å¼: æ¼”ç¤ºæ¨¡å¼ï¼ˆç®€åŒ–è®¤è¯ï¼‰');
        };
    </script>
</body>
</html>

