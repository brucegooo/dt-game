# 系统设计

1. web server：
     职责：
       1. 接收用户投注（bet接口）；
       
       2. 输入游戏事件：
            beego.Router("/api/game_event", &api.GameEventController{}, "post:GameEvent")
          这个接口的作用是：
           接口输入 1 game_start 事件触发：
                     1.1 生成局信息表数据（写数据库game_round_info 插入一条记录）bet_start_time 写当前时间 我这里要求下注时间只有15s；
                     1.2 将game_round_info数据写入到消息队列中；
                     1.3 同时将生成的局信息数据写入到outbox表中；
                     1.4 将局信息维护进redis 过期时间20s
                     1.5 将局信息包含开始下注时间和停住下注时间返回给客户端；（前端可以自己计算倒计时，或者接口扩展一个倒计时的字段 数值类型 秒）
                     

           接口输入 2 game_stop 事件触发：
                     2.1 更新game_round_info表的bet_stop_time字段为当前时间
                     2.2 更新game_round_info表的game_status字段为3

           接口输入 3 new_card 事件触发：
                    3.1 更新game_round_info表的game_status字段为4
        
           接口输入 4 game_draw 事件触发：
                    4.1 通过http接口/api/drawresult 人工输入开奖结果
                    4.2 更新game_round_info表的game_status字段为5
                    4.3 更新game_round_info表的game_draw_time字段为当前时间
                    4.4 将开奖结果写入到outbox表中
                    4.5 将开奖结果写入到redis中
                    4.6 将开奖结果写入到消息队列中  
                    4.7 将开奖结果打印到控制台
                    4.8 收到人工输入的开奖结果以后开始对对应的局订单进行结算
                    4.9 结算完成后更新orders表的bill_status字段为2
                    4.10 写账变入账本表wallet_ledger
        
            接口输入 5 game_end 事件触发：  
                    5.1 更新game_round_info表的game_status字段为6；
                    5.2 将game_end事件写入到outbox表中
                    5.3 将game_end事件写入到消息队列中
                    5.4 从redis中删除局信息
   


        3. 接收游戏开奖结果；（http接口接收人工开奖[用于模拟开奖] 和 消费消息队列开奖结果消息）


    // 投注
	beego.Router("/api/bet", &api.BetController{}, "post:Bet")

	// 游戏事件(这里为了方便演示，使用http接口来触发游戏事件)
	beego.Router("/api/game_event", &api.GameEventController{}, "post:GameEvent")

	// 开奖结果
	beego.Router("/api/drawresult", &api.DrawResultController{}, "post:Drawresult")

2. 消息队列服务：
    职责：
        1.异步解耦下注附加业务（这里主要是下注业务相关的其他可以异步的操作，比如用户成就，数据统计等等，因为下注业务本身是必须要求实时同步的）
        2.与客户端和web server通信：游戏事件 例如：开始游戏，停止下注，发牌，开奖，结束游戏
        3.接收到开奖结果后，触发结算业务。

3. 风控，监控业务
    职责：
        1.错误或者异常游戏数据的修复和补偿；
        2.游戏结果的回放；
        3.用户游戏数据的全链路日志（主要是下注和游戏结果的结算）；


开发笔记：
    1.orders表的设计，需要考虑大数据量，支持按业务投注平台分表；
    2.投注接口的高并发支持；
    3.投注接口的幂等性设计，需要前后端配合；
    4.开奖结算要求的速度；





